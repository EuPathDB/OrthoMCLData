#!/usr/bin/perl

use strict;

usage() if scalar(@ARGV) != 2;

my ($ncbi_taxon_id, $output_map_file) = @ARGV;

=head
AC   Q7ZVB2; Q6NYB3;
DR   Ensembl; ENSDART00000100283; ENSDARP00000091056; ENSDARG00000069100.
DR   Ensembl; ENSDART00000137838; ENSDARP00000118280; ENSDARG00000069100.
DR   GeneID; 100005587; -.
//
AC   Q802W2; A2AWD6;
DR   Ensembl; ENSDART00000053868; ENSDARP00000053867; ENSDARG00000037061.
DR   GeneID; 399481; -.
//
AC   Q8JG69;
DR   GeneID; 266755; -.
//
AC   Q8JG70;
//
=cut


my @localAccessions;
my %localGenes;
my @localEntrezGenes;
my @localEnsemblGenes;
my $proteinsCount;
my %keptGenes;

my $url = "\"http://www.uniprot.org/uniprot/?fil=taxonomy:$ncbi_taxon_id&format=txt\"";

open(W, "wget $url -qO- |") || die "Failed running 'wget $url -qO-'\n";

open(M, ">$output_map_file") || die "Can't open output map file '$output_map_file' for writing\n";

while(<W>) {
  chomp;

  # handle a new set of accessions
  if (/^AC/) {
    my $line = $_;
    my @a = split(/\s+/, $line);
    shift(@a);  #lose AC
    @localAccessions = map { s/;//; $_; } @a;  # lose trailing semi-colon on accessions
    %localGenes = ();
  }

  # an entrez gene ID
  elsif (/^DR\s+GeneID;/) {
    /^DR\s+GeneID;\s+(\d+);\s+\-\.$/ || die "DR GeneID line not in expected format\n$_\n";
    $localGenes{$1} = 1;
  }

  # an ensembl gene ID
  elsif (/^DR\s+Ensembl;/) {
    /^DR\s+Ensembl;.+(ENS\w+G\d+)\./ || die "DR Ensembl line not in expected format\n$_\n";
    $localGenes{$1} = 1;
  }

  # process this completed record
  elsif (/^\/\//) {
    my @genes = sort(keys(%localGenes));
    foreach my $acc (@localAccessions) {
      $proteinsCount++;
      my $gene = $genes[0];
      if ($gene) {
	print M "$acc\t$gene\n";
	$keptGenes{$gene} = 1;
      }
    }
  }
}
close(M);

my $genesCount = scalar(keys(%keptGenes));
print STDERR "Uniprot Count Summary - proteins: $proteinsCount genes: $genesCount\n";

sub usage {
  die "

Parse Uniprot text file (genbank format) to find Entrez and Ensembl gene IDs for each protein, as available.

Usage: getUniprotGeneIdMap output_mapping_file

Where:
  output_mapping_file:  a tab-delimited file, first column protein ID, next column gene ID

Calls this to get the text file:
  wget \"http://www.uniprot.org/uniprot/?fil=taxonomy:7955&format=txt\" -qO- 


The approach is to read the large genbank-like text file (input from uniprot), and find the mapping of gene IDs
to proteins. 

For each protein, keep the alphabetically first geneId.

";
}
