#!@perl@
use strict;

use lib "$ENV{GUS_HOME}/lib/perl";
use File::Basename;
use ApiCommonData::Load::Steps;
use ApiCommonData::Load::MakeTaskDirs;

my $propertiesFile = $ARGV[0];
my $printXML = $ARGV[1];

my ($mgr, $projectDir, $release, $allSpecies)
  = &initOrthomclAnalysis($propertiesFile, $printXML);

&copyPipelineDirToComputeCluster($mgr);

##############################################################################
########   The Pipeline                                               ########
##############################################################################


##### all proteomes vs all proteomes ncbi blastp #####

my $blastParams = "-F 'm S' -v 100000 -b 100000 -z 1300000 -e 1e-5";

my $minLength = 10;
my $maxStopCodonPercent = 20;
my $fetchSql = "select aa_sequence_id, source_id, sequence FROM dots.externalaasequence";

&documentBlast($mgr, 'BLASTP', "Protein sequences", "Protein sequences", $blastParams);

&createSimilarityDir($mgr,"ProteinSeqs","ProteinSeqs","([0-9]+)","$blastParams","blastp", "ncbi");

&extractProteinSeqs($mgr, "ProteinSeqs", $fetchSql, $minLength, $maxStopCodonPercent);

&copyFilesToComputeCluster($mgr,"ProteinSeqs-ProteinSeqs", "similarity");

&copyFilesToComputeCluster($mgr,"ProteinSeqs.fsa","seqfiles");

&startProteinBlastOnComputeCluster($mgr,"ProteinSeqs","ProteinSeqs","apidb");

#$mgr->waitForCluster("ProteinSeqs blast similarity", "waitProteinSeqs-ProteinSeqs");

&copyFilesFromComputeCluster($mgr,"ProteinSeqs-ProteinSeqs", "similarity");

&parseBlastForSqlldr ($mgr,"ProteinSeqs-ProteinSeqs");

&loadBlastWithSqlldr($mgr,"ProteinSeqs-ProteinSeqs");

&orthomclPairs ($mgr, "no", "ortholog2WayIndex");

&makeOrthoAbcFile ($mgr);

&runMcl ($mgr, '1.5');

&mclOutToGroupsFile ($mgr);

# ##### iprscan #####
my $insertInterproConfig = "$projectDir/$release/insertInterpro-config.xml";
 
&documentIPRScan($mgr,"v4.3.1");

&createIprscanDir($mgr, "ProteinSeqs.fsa");

&copyFilesToComputeCluster($mgr,"iprscan");

&startIprScanOnComputeCluster($mgr,"ProteinSeqs.fsa","apidb", 1);

&loadOrthoMCLResultsForOrthomclDB($mgr, "OrthoMCL", "3.0", "orthomclGroups.txt");

# $mgr->waitForCluster("ProteinSeqs interproscan", "waitProteinSeqs-Interproscan");

&copyFilesFromComputeCluster($mgr,"ProteinSeqs.fsa","iprscan");

&loadIprscanResults($mgr,"ProteinSeqs.fsa", "INTERPRO","19.0",$insertInterproConfig, 'ExternalAASequence', '--srcIdColumn aa_sequence_id');

&updateOrthologGroups($mgr);

&extractFilesForMsa($mgr);

#&updateOrthoMCLGroups-not called this($mgr, "muscle3.6");  #this is what makes the msa
#muscle -in <inputfile> -out <outputfile> -clw -log       
# must have a step to make the fasta files in groups but only those groups with less than 100 sequences
#use extractGroupFastaFiles in OrthoMCLData/Load/bin to make the files - not tested yet

#&loadMsaResult($mgr, $msaName);#where are we getting this file???

# &generateOrthomclDomainKeywords($mgr);#after iprscan, every protein should have domains, index the verbiage with this

# my $rbhFile = "$projectDir/$release/analysis_pipeline/primary/data/orthomclEng/master/mainresult/orthomcl.rbh"; #do differently
# my $svgTemplate = "$ENV{GUS_HOME}/data/OrthoMCLData/Load/svg.template"; 

# &createBiolayoutData($mgr, $rbhFile, $svgTemplate);

# add step to map old ids to new ones

#add step to map to inprot

#add a step to use orthomclDumpPairsFiles for download site 

#
#
# Last step
#
$mgr->goodbye("Pipeline complete!\n");

